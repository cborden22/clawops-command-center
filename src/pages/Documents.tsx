import { useState } from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group"
import { useToast } from "@/hooks/use-toast"
import { FileText, Download } from "lucide-react"
import html2pdf from "html2pdf.js"

interface FormData {
  [key: string]: string
}

export default function Documents() {
  const { toast } = useToast()
  const [formData, setFormData] = useState<FormData>({})
  const [paymentType, setPaymentType] = useState<"percentage" | "flat">("percentage")

  const locationAgreementFields = [
    "Agreement Date",
    "Provider Name", 
    "Provider Address",
    "Provider Contact Info",
    "Business Name",
    "Business Address", 
    "Business Contact Info",
    "Start Date",
    "End Date",
    "Payment Method",
    "Notice Period (Hours/Days)"
  ]

  const handleFormChange = (field: string, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }))
  }

  const handleDownloadPDF = async () => {
    console.log('Starting PDF generation...', { formData })

    try {
      const filename = `${formData["Business Name"] || "Location"}_Agreement_${new Date().toISOString().split('T')[0]}.pdf`
      
      const currentDate = formData["Agreement Date"] || new Date().toLocaleDateString()
      const paymentDetails = paymentType === "percentage" 
        ? `${formData["Revenue Share Percentage"] || "[%]"}% of all revenue generated by the Machine(s)`
        : `$${formData["Flat Fee Amount"] || "[Amount]"} per month (flat fee)`

      // Create a temporary div with the PDF content
      const tempDiv = document.createElement('div')
      tempDiv.style.position = 'absolute'
      tempDiv.style.left = '-9999px'
      tempDiv.style.top = '-9999px'
      tempDiv.style.width = '210mm'
      tempDiv.style.fontFamily = 'Arial, sans-serif'
      tempDiv.style.background = 'white'
      
      tempDiv.innerHTML = `
        <div style="max-width: 700px; margin: 0 auto; padding: 30px; font-family: Arial, sans-serif; line-height: 1.4; color: #333;">
          
          <!-- Header -->
          <div style="text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid #2563eb;">
            <h1 style="font-size: 24px; font-weight: bold; color: #1e40af; margin: 0 0 10px 0; letter-spacing: 1px;">
              CLAW MACHINE PLACEMENT AGREEMENT
            </h1>
            <h2 style="font-size: 16px; color: #64748b; margin: 0 0 20px 0; font-weight: normal;">
              Standard 1-Year Term
            </h2>
            <div style="background: #f1f5f9; padding: 12px 20px; border-radius: 8px; display: inline-block; border: 1px solid #cbd5e1;">
              <strong>Effective Date: ${currentDate}</strong>
            </div>
          </div>

          <!-- Parties Section -->
          <div style="margin-bottom: 35px;">
            <h3 style="font-size: 16px; font-weight: bold; color: #1e40af; margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 0.5px;">
              Parties to This Agreement
            </h3>
            
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
              <div style="flex: 1; border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; background: #f8fafc;">
                <h4 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 15px 0; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #cbd5e1;">
                  Claw Machine Provider
                </h4>
                <p style="margin: 0 0 8px 0; font-size: 12px;"><strong>Name:</strong> ${formData["Provider Name"] || "[Provider Name]"}</p>
                <p style="margin: 0 0 8px 0; font-size: 12px;"><strong>Address:</strong> ${formData["Provider Address"] || "[Provider Address]"}</p>
                <p style="margin: 0 0 8px 0; font-size: 12px;"><strong>Contact:</strong> ${formData["Provider Contact Info"] || "[Contact Information]"}</p>
              </div>
              
              <div style="flex: 1; border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; background: #f8fafc;">
                <h4 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 15px 0; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #cbd5e1;">
                  Business Location Owner
                </h4>
                <p style="margin: 0 0 8px 0; font-size: 12px;"><strong>Name:</strong> ${formData["Business Name"] || "[Business Name]"}</p>
                <p style="margin: 0 0 8px 0; font-size: 12px;"><strong>Address:</strong> ${formData["Business Address"] || "[Business Address]"}</p>
                <p style="margin: 0 0 8px 0; font-size: 12px;"><strong>Contact:</strong> ${formData["Business Contact Info"] || "[Contact Information]"}</p>
              </div>
            </div>
            
            <p style="text-align: center; font-style: italic; color: #64748b; font-size: 11px; margin: 15px 0 0 0;">
              Together referred to as "the Parties."
            </p>
          </div>

          <!-- Agreement Terms -->
          <div style="margin-bottom: 25px; padding: 20px; border-left: 4px solid #3b82f6; background: #fafbff; border-radius: 0 8px 8px 0;">
            <h3 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0;">1. PURPOSE</h3>
            <p style="font-size: 12px; line-height: 1.6; margin: 0; color: #374151;">
              The Provider agrees to place and operate one or more claw machines (the "Machine(s)") at the Location Owner's place of business. The Location Owner agrees to host the Machine(s) in exchange for compensation as outlined in Section 3.
            </p>
          </div>

          <div style="margin-bottom: 25px; padding: 20px; border-left: 4px solid #3b82f6; background: #fafbff; border-radius: 0 8px 8px 0;">
            <h3 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0;">2. TERM</h3>
            <p style="font-size: 12px; line-height: 1.6; margin: 0; color: #374151;">
              This Agreement is valid for <strong>12 months</strong>, beginning on <strong>${formData["Start Date"] || "[Start Date]"}</strong> and ending on <strong>${formData["End Date"] || "[End Date]"}</strong>, unless terminated earlier as outlined in Section 9.
            </p>
          </div>

          <!-- Compensation Highlight -->
          <div style="margin-bottom: 25px; padding: 25px; background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 8px;">
            <h3 style="font-size: 14px; font-weight: bold; color: #92400e; margin: 0 0 15px 0;">3. COMPENSATION</h3>
            <p style="font-size: 12px; line-height: 1.6; margin: 0 0 10px 0; color: #374151;">
              The Provider will collect all revenue from the Machine(s) and compensate the Location Owner with:
            </p>
            <div style="font-size: 14px; font-weight: bold; color: #92400e; background: #fffbeb; padding: 12px 15px; border-radius: 6px; text-align: center; border: 1px solid #fbbf24; margin: 10px 0;">
              ${paymentDetails}
            </div>
            <p style="font-size: 12px; line-height: 1.6; margin: 0; color: #374151;">
              Payments will be made by the <strong>10th of each month</strong> for the prior month's earnings via <strong>${formData["Payment Method"] || "[Payment Method]"}</strong>.
            </p>
          </div>

          <div style="margin-bottom: 25px; padding: 20px; border-left: 4px solid #3b82f6; background: #fafbff; border-radius: 0 8px 8px 0;">
            <h3 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 15px 0;">4. RESPONSIBILITIES</h3>
            
            <div style="display: flex; gap: 20px;">
              <div style="flex: 1; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                <h4 style="font-size: 12px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0; text-align: center; padding-bottom: 6px; border-bottom: 1px solid #e2e8f0;">
                  Provider Responsibilities
                </h4>
                <ul style="margin: 0; padding: 0; list-style: none;">
                  <li style="margin-bottom: 6px; padding-left: 15px; position: relative; font-size: 11px;">• Owns all machines and their contents</li>
                  <li style="margin-bottom: 6px; padding-left: 15px; position: relative; font-size: 11px;">• Handles installation, restocking, and servicing</li>
                  <li style="margin-bottom: 6px; padding-left: 15px; position: relative; font-size: 11px;">• Covers all maintenance and repairs</li>
                  <li style="margin-bottom: 6px; padding-left: 15px; position: relative; font-size: 11px;">• Pays for electricity usage</li>
                  <li style="margin-bottom: 6px; padding-left: 15px; position: relative; font-size: 11px;">• Provides timely revenue reporting</li>
                </ul>
              </div>
              
              <div style="flex: 1; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                <h4 style="font-size: 12px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0; text-align: center; padding-bottom: 6px; border-bottom: 1px solid #e2e8f0;">
                  Location Owner Responsibilities
                </h4>
                <ul style="margin: 0; padding: 0; list-style: none;">
                  <li style="margin-bottom: 6px; padding-left: 15px; position: relative; font-size: 11px;">• Provides accessible space for Machine(s)</li>
                  <li style="margin-bottom: 6px; padding-left: 15px; position: relative; font-size: 11px;">• Supplies power outlet near placement area</li>
                  <li style="margin-bottom: 6px; padding-left: 15px; position: relative; font-size: 11px;">• Maintains general cleanliness around machine</li>
                  <li style="margin-bottom: 6px; padding-left: 15px; position: relative; font-size: 11px;">• Ensures customer access during business hours</li>
                  <li style="margin-bottom: 6px; padding-left: 15px; position: relative; font-size: 11px;">• Cooperates with maintenance schedules</li>
                </ul>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 25px; padding: 20px; border-left: 4px solid #3b82f6; background: #fafbff; border-radius: 0 8px 8px 0;">
            <h3 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0;">5. THEFT, DAMAGE & COOPERATION</h3>
            <p style="font-size: 12px; line-height: 1.6; margin: 0 0 10px 0; color: #374151;">
              The Location Owner will not be held liable for theft, vandalism, or accidental damage to the Machine(s).
            </p>
            <p style="font-size: 12px; font-weight: bold; margin: 0 0 8px 0; color: #374151;">
              In the event of incidents, the Location Owner agrees to:
            </p>
            <ul style="margin: 0; padding: 0 0 0 20px; list-style: none;">
              <li style="margin-bottom: 4px; font-size: 11px;">• Provide available security footage, if applicable</li>
              <li style="margin-bottom: 4px; font-size: 11px;">• Allow access for inspection and assessment</li>
              <li style="margin-bottom: 4px; font-size: 11px;">• Cooperate with law enforcement or insurance representatives</li>
              <li style="margin-bottom: 4px; font-size: 11px;">• Notify Provider within 24 hours of any incidents</li>
            </ul>
          </div>

          <div style="margin-bottom: 25px; padding: 20px; border-left: 4px solid #3b82f6; background: #fafbff; border-radius: 0 8px 8px 0;">
            <h3 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0;">6. INSURANCE & LIABILITY</h3>
            <p style="font-size: 12px; line-height: 1.6; margin: 0; color: #374151;">
              The Provider is responsible for carrying comprehensive insurance for equipment and general liability. The Location Owner assumes no liability for injuries or damages related to the Machine(s), except in cases of gross negligence.
            </p>
          </div>

          <div style="margin-bottom: 25px; padding: 20px; border-left: 4px solid #3b82f6; background: #fafbff; border-radius: 0 8px 8px 0;">
            <h3 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0;">7. MARKETING & SIGNAGE</h3>
            <p style="font-size: 12px; line-height: 1.6; margin: 0; color: #374151;">
              The Provider may display branding and promotional signage on or immediately near the Machine(s). Any additional signage in other areas of the premises must receive prior written approval from the Location Owner.
            </p>
          </div>

          <div style="margin-bottom: 25px; padding: 20px; border-left: 4px solid #3b82f6; background: #fafbff; border-radius: 0 8px 8px 0;">
            <h3 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0;">8. RELOCATION OR REMOVAL</h3>
            <p style="font-size: 12px; line-height: 1.6; margin: 0; color: #374151;">
              The Provider may replace, relocate, or remove the Machine(s) with <strong>${formData["Notice Period (Hours/Days)"] || "[Notice Period]"}</strong> notice to the Location Owner. The Location Owner may request relocation of the machine within the business premises if operationally necessary.
            </p>
          </div>

          <div style="margin-bottom: 25px; padding: 20px; border-left: 4px solid #3b82f6; background: #fafbff; border-radius: 0 8px 8px 0;">
            <h3 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0;">9. TERMINATION</h3>
            <p style="font-size: 12px; line-height: 1.6; margin: 0; color: #374151;">
              Either party may terminate this Agreement with <strong>30 days' written notice</strong>. Immediate termination is permitted in the event of material breach that remains uncured after 7 days' written notice.
            </p>
          </div>

          <div style="margin-bottom: 25px; padding: 20px; border-left: 4px solid #3b82f6; background: #fafbff; border-radius: 0 8px 8px 0;">
            <h3 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0;">10. RENEWAL</h3>
            <p style="font-size: 12px; line-height: 1.6; margin: 0; color: #374151;">
              If neither party provides written notice of termination at least 30 days before the end date, this Agreement automatically renews for another 12-month term under the same conditions.
            </p>
          </div>

          <div style="margin-bottom: 35px; padding: 20px; border-left: 4px solid #3b82f6; background: #fafbff; border-radius: 0 8px 8px 0;">
            <h3 style="font-size: 14px; font-weight: bold; color: #1e40af; margin: 0 0 12px 0;">11. ENTIRE AGREEMENT</h3>
            <p style="font-size: 12px; line-height: 1.6; margin: 0; color: #374151;">
              This document represents the complete agreement between the Parties. Any amendments must be in writing and signed by both Parties. This Agreement supersedes all prior negotiations, understandings, or agreements.
            </p>
          </div>

          <!-- Signatures Section -->
          <div style="margin-top: 40px; padding-top: 25px; border-top: 3px solid #e2e8f0;">
            <h3 style="text-align: center; font-size: 16px; font-weight: bold; color: #1e40af; margin: 0 0 30px 0; text-transform: uppercase; letter-spacing: 1px;">
              Signatures
            </h3>
            
            <div style="display: flex; gap: 40px; justify-content: space-between;">
              <div style="flex: 1; text-align: center;">
                <h4 style="font-size: 12px; font-weight: bold; color: #374151; margin: 0 0 20px 0;">
                  Claw Machine Provider
                </h4>
                <div style="border-bottom: 2px solid #1e40af; width: 200px; height: 30px; margin: 0 auto 10px auto;"></div>
                <p style="font-size: 11px; color: #64748b; margin: 0;">
                  <strong>Signature</strong><br>
                  Date: _________________
                </p>
              </div>
              
              <div style="flex: 1; text-align: center;">
                <h4 style="font-size: 12px; font-weight: bold; color: #374151; margin: 0 0 20px 0;">
                  Business Location Owner
                </h4>
                <div style="border-bottom: 2px solid #1e40af; width: 200px; height: 30px; margin: 0 auto 10px auto;"></div>
                <p style="font-size: 11px; color: #64748b; margin: 0;">
                  <strong>Signature</strong><br>
                  Date: _________________
                </p>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div style="text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 10px; color: #9ca3af;">
            Generated on ${new Date().toLocaleDateString()} by ClawOps Document Creator
          </div>
        </div>
      `

      document.body.appendChild(tempDiv)
      
      // Generate PDF with better options
      const opt = {
        margin: [10, 10, 10, 10],
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          useCORS: true,
          letterRendering: true,
          allowTaint: true
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait',
          compress: true
        }
      }

      await html2pdf().from(tempDiv).set(opt).save()
      
      // Clean up
      document.body.removeChild(tempDiv)

      toast({
        title: "PDF Downloaded Successfully",
        description: "Your location agreement has been saved to your downloads folder.",
      })

    } catch (error) {
      console.error('PDF generation error:', error)
      toast({
        title: "PDF Generation Failed",
        description: "There was an error generating the PDF. Please try again.",
        variant: "destructive"
      })
    }
  }

  const handleClearForm = () => {
    setFormData({})
    setPaymentType("percentage")
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-foreground">Location Agreement Creator</h1>
          <p className="text-muted-foreground mt-2">
            Create professional claw machine placement agreements
          </p>
        </div>
        <Button 
          variant="outline"
          onClick={handleClearForm}
        >
          Clear Form
        </Button>
      </div>

      {/* Single Card for Location Agreement */}
      <Card className="shadow-card">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <FileText className="h-5 w-5" />
            Claw Machine Placement Agreement
          </CardTitle>
          <CardDescription>
            Fill in the information below to generate your professional location agreement
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {locationAgreementFields.map((field) => (
            <div key={field} className="space-y-2">
              <Label htmlFor={field.toLowerCase().replace(/\s+/g, '-')}>
                {field}
              </Label>
              <Input
                id={field.toLowerCase().replace(/\s+/g, '-')}
                placeholder={`Enter ${field.toLowerCase()}...`}
                value={formData[field] || ""}
                onChange={(e) => handleFormChange(field, e.target.value)}
              />
            </div>
          ))}

          {/* Payment Type Selection */}
          <div className="space-y-4 border-t pt-4">
            <Label className="text-base font-semibold">Payment Structure</Label>
            <RadioGroup 
              value={paymentType} 
              onValueChange={(value: "percentage" | "flat") => setPaymentType(value)}
              className="space-y-3"
            >
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="percentage" id="percentage" />
                <Label htmlFor="percentage" className="cursor-pointer">
                  Revenue Share Percentage
                </Label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="flat" id="flat" />
                <Label htmlFor="flat" className="cursor-pointer">
                  Flat Monthly Fee
                </Label>
              </div>
            </RadioGroup>

            {/* Conditional Input Fields */}
            {paymentType === "percentage" ? (
              <div className="space-y-2">
                <Label htmlFor="revenue-share">Revenue Share Percentage (%)</Label>
                <Input
                  id="revenue-share"
                  type="number"
                  min="0"
                  max="100"
                  placeholder="e.g., 50"
                  value={formData["Revenue Share Percentage"] || ""}
                  onChange={(e) => handleFormChange("Revenue Share Percentage", e.target.value)}
                />
              </div>
            ) : (
              <div className="space-y-2">
                <Label htmlFor="flat-fee">Monthly Flat Fee ($)</Label>
                <Input
                  id="flat-fee"
                  type="number"
                  min="0"
                  placeholder="e.g., 500"
                  value={formData["Flat Fee Amount"] || ""}
                  onChange={(e) => handleFormChange("Flat Fee Amount", e.target.value)}
                />
              </div>
            )}
          </div>
          
          <div className="pt-4">
            <Button 
              className="bg-gradient-primary hover:bg-primary/90 w-full"
              onClick={handleDownloadPDF}
            >
              <Download className="h-4 w-4 mr-2" />
              Generate Location Agreement PDF
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}